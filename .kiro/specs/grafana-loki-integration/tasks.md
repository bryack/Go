# Implementation Plan

- [x] 1. Create Docker Compose configuration for Grafana Loki stack
  - Create `docker-compose.loki.yml` file at project root (not in examples/)
  - Define task-manager service with Loki logging driver configuration
  - Define Loki service with port 3100 exposed
  - Define Grafana service with port 3000 exposed
  - Configure service dependencies (task-manager → loki → grafana)
  - Add Docker volumes for Loki data persistence and Grafana data persistence
  - Configure environment variables for task-manager (JSON logging, stdout output, service name, environment label)
  - Configure Loki logging driver options (batch size, retries, timeout, labels)
  - Add comprehensive inline documentation and usage examples
  - Note: Grafana provisioning file mounts are commented out (will be created in tasks 3-4)
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3_

- [ ]* 2. Create Loki configuration file (OPTIONAL)
  - Note: docker-compose.loki.yml uses Loki's built-in local-config.yaml (suitable for development)
  - Optional: Create custom `loki-config.yaml` file for advanced configuration
  - Configure server settings (HTTP port 3100)
  - Configure ingester settings (chunk idle period, retention)
  - Configure schema for BoltDB shipper with filesystem storage
  - Configure storage paths for index and chunks
  - Set retention period to 7 days (168 hours)
  - Configure limits (reject old samples, max look back period)
  - Enable retention deletion in table manager
  - Mount custom config in docker-compose.loki.yml if created
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ]* 3. Create Grafana data source provisioning configuration (OPTIONAL)
  - Note: Manual configuration in Grafana UI is simpler for learning (3 clicks)
  - Optional: Create `grafana-datasources.yaml` file at project root for auto-provisioning
  - Define Loki data source with name "Loki"
  - Set Loki URL to http://loki:3100 (Docker network hostname)
  - Configure as default data source
  - Set access mode to proxy
  - Configure max lines to 1000
  - Add derived field for request_id extraction
  - Uncomment the volume mount in docker-compose.loki.yml
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 4. Create Grafana dashboard provisioning configuration (OPTIONAL)
  - Note: Manual dashboard import is simpler for learning
  - Optional: Create `grafana-dashboards.yaml` file at project root for auto-provisioning
  - Define dashboard provider pointing to /var/lib/grafana/dashboards
  - Set folder name to "Task Manager"
  - Enable UI updates and disable deletion protection
  - Configure update interval to 10 seconds
  - Uncomment the volume mount in docker-compose.loki.yml
  - _Requirements: 3.5, 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 5. Create Application Overview dashboard (OPTIONAL)
  - Note: Users learn more by creating dashboards manually using Grafana UI
  - Note: All necessary LogQL queries are documented in GETTING_STARTED_LOKI.md
  - Optional: Create `dashboards/` directory at project root
  - Optional: Create `dashboards/application-overview.json` file
  - Add panel for log volume over time (count_over_time query)
  - Add panel for error rate per minute (rate query with level="ERROR")
  - Add panel for request count by endpoint (count by path)
  - Add panel for recent errors (last 20 ERROR level logs)
  - Add panel for recent warnings (last 20 WARN level logs)
  - Configure time range selector (default: last 1 hour)
  - Configure auto-refresh (30 seconds)
  - Uncomment the dashboards volume mount in docker-compose.loki.yml
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 6. Create Request Performance dashboard (OPTIONAL)
  - Note: Manual dashboard creation is recommended for learning
  - Optional: Create `dashboards/request-performance.json` file
  - Add panel for average request duration by endpoint (avg_over_time with unwrap duration_ms)
  - Add panel for 95th percentile request duration (quantile_over_time)
  - Add panel for slowest requests in last hour (topk with duration_ms)
  - Add panel for request count by status code (count by status_code)
  - Add panel for request count by HTTP method (count by method)
  - Configure time range selector (default: last 1 hour)
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [ ]* 7. Create Authentication & Security dashboard (OPTIONAL)
  - Note: Manual dashboard creation is recommended for learning
  - Optional: Create `dashboards/authentication-security.json` file
  - Add panel for failed login attempts (count with msg=~".*login.*" and level="WARN")
  - Add panel for successful registrations (count with msg=~".*registration.*")
  - Add panel for JWT validation failures (count with msg=~".*JWT.*" and level="WARN")
  - Add panel for authorization failures by user (count by user_id)
  - Add panel for recent authentication events (last 50 logs)
  - Configure time range selector (default: last 1 hour)
  - _Requirements: 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ]* 8. Create Error Analysis dashboard (OPTIONAL)
  - Note: Manual dashboard creation is recommended for learning
  - Optional: Create `dashboards/error-analysis.json` file
  - Add panel for error count by operation (count by operation with level="ERROR")
  - Add panel for top 10 error messages (topk with count by msg)
  - Add panel for errors by user_id (count by user_id with level="ERROR")
  - Add panel for errors by endpoint (count by path with level="ERROR")
  - Add panel for error timeline over 24 hours (count_over_time)
  - Configure time range selector (default: last 24 hours)
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [ ]* 9. Create Quick Start documentation
  - Create `docs/GRAFANA_LOKI_QUICKSTART.md` file
  - Document prerequisites (Docker, Docker Compose, Docker Loki plugin)
  - Provide Docker Loki plugin installation command for Linux/macOS/Windows
  - Provide verification command (docker plugin ls)
  - Document startup command (docker-compose up -d)
  - Document how to access Grafana (http://localhost:3000)
  - Provide first query examples (basic label filtering)
  - Document how to verify logs are flowing (check Loki labels API)
  - Add troubleshooting section for common issues
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 13.1, 13.2, 13.3, 13.4, 13.5_

- [ ]* 10. Create LogQL Query Reference documentation
  - Create `docs/LOGQL_QUERY_REFERENCE.md` file
  - Document basic query syntax (label selectors)
  - Document JSON field extraction (| json)
  - Document text search operators (|=, !=, |~, !~)
  - Document filtering by extracted fields (level="ERROR")
  - Document aggregation functions (count_over_time, rate, sum, avg)
  - Document time range queries ([5m], [1h], [24h])
  - Provide query examples for filtering by request_id
  - Provide query examples for filtering by user_id
  - Provide query examples for filtering by log level
  - Provide query examples for searching message text
  - Provide query examples for counting errors per minute
  - Provide query examples for finding slowest requests
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8_

- [ ]* 11. Create Dashboard Guide documentation
  - Create `docs/GRAFANA_DASHBOARDS.md` file
  - Document overview of pre-built dashboards (Application Overview, Performance, Security, Errors)
  - Document how to navigate dashboards in Grafana UI
  - Document how to use time range selector
  - Document how to use live tail mode
  - Document how to create custom dashboards
  - Document panel types (logs, time series, stat, table)
  - Provide query examples for each panel type
  - Document how to share dashboards (export JSON, share link)
  - Document how to export query results (JSON, CSV)
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 20.1, 20.2, 20.3, 20.4, 20.5_

- [ ]* 12. Create Troubleshooting Guide documentation
  - Create `docs/GRAFANA_LOKI_TROUBLESHOOTING.md` file
  - Document solution for "Docker Loki plugin not found" error
  - Document solution for "No logs appearing in Grafana" issue
  - Document solution for "Loki connection refused" error
  - Document solution for "Query timeout" issues
  - Document how to verify Docker Loki plugin is installed
  - Document how to verify Loki is receiving logs (curl API)
  - Document how to check Loki container logs
  - Document how to check Grafana container logs
  - Document how to verify network connectivity between containers
  - Document how to reset Grafana Loki (docker-compose down -v)
  - Document how to check disk space usage
  - _Requirements: 14.1, 14.2, 14.3, 14.4, 14.5, 17.1, 17.2, 17.3, 17.4, 17.5_

- [ ]* 13. Create startup script for convenience (OPTIONAL - LIKELY NOT NEEDED)
  - Note: docker-compose.loki.yml already has excellent inline documentation with all commands
  - Note: The Docker Loki driver approach is simpler than Promtail and doesn't need a wrapper script
  - Optional: Create `start-loki.sh` shell script at project root if users request it
  - Check if Docker Loki plugin is installed (docker plugin ls | grep loki)
  - If not installed, display installation instructions and exit
  - Start Docker Compose using docker-compose.loki.yml
  - Wait for services to be healthy (sleep 10 seconds)
  - Verify Loki is accessible (curl http://localhost:3100/ready)
  - Verify Grafana is accessible (curl http://localhost:3000/api/health)
  - Display success message with URLs
  - Make script executable (chmod +x)
  - _Requirements: 19.1, 19.2, 19.3, 19.4_

- [ ]* 14. Create stop script for convenience (OPTIONAL - LIKELY NOT NEEDED)
  - Note: Simple command already documented in docker-compose.loki.yml
  - Note: Command is: docker compose -f docker-compose.loki.yml down
  - Optional: Create `stop-loki.sh` shell script at project root if users request it
  - Add shebang and script description
  - Stop Docker Compose services using docker-compose.loki.yml
  - Display confirmation message
  - Make script executable (chmod +x)
  - _Requirements: 19.2_

- [ ]* 15. Create cleanup script for resetting data (OPTIONAL - LIKELY NOT NEEDED)
  - Note: Simple command already documented in docker-compose.loki.yml
  - Note: Command is: docker compose -f docker-compose.loki.yml down -v
  - Optional: Create `cleanup-loki.sh` shell script at project root if users request it
  - Add shebang and script description
  - Prompt user for confirmation (destructive operation)
  - Stop Docker Compose services using docker-compose.loki.yml
  - Remove Docker volumes (docker compose -f docker-compose.loki.yml down -v)
  - Display confirmation message
  - Make script executable (chmod +x)
  - _Requirements: 7.5, 17.5_

- [ ]* 16. Update main README with Grafana Loki section
  - Update `README.md` file
  - Add "Log Analysis with Grafana Loki" section
  - Provide brief overview of Grafana Loki integration
  - Link to GRAFANA_LOKI_QUICKSTART.md for setup instructions
  - Link to LOGQL_QUERY_REFERENCE.md for query examples
  - Link to GRAFANA_DASHBOARDS.md for dashboard guide
  - Mention pre-built dashboards
  - Add screenshot or example of Grafana dashboard (optional)
  - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5_

- [ ]* 17. Create Production Deployment Guide
  - Create `docs/GRAFANA_LOKI_PRODUCTION.md` file
  - Document differences between local and production setup
  - Recommend enabling Grafana authentication for production
  - Recommend enabling Loki authentication (multi-tenancy)
  - Recommend using TLS/HTTPS for all connections
  - Recommend using remote storage (S3, GCS) instead of local filesystem
  - Recommend increasing retention period for production (30+ days)
  - Document how to send logs from remote servers to centralized Loki
  - Document backup and disaster recovery considerations
  - Document monitoring and alerting setup
  - Document resource requirements (CPU, RAM, disk)
  - _Requirements: 16.1, 16.2, 16.3, 16.4, 16.5_

- [ ]* 18. Create example environment-specific configurations (OPTIONAL - NOT NEEDED)
  - Note: The existing docker-compose.loki.yml already supports multi-environment configuration
  - Note: Change environment via TASKMANAGER_LOGGING_ENVIRONMENT variable
  - Note: Run multiple environments simultaneously using docker compose -p flag
  - Note: All requirements (2.1-2.5, 9.1-9.5) are satisfied by existing implementation
  - Optional: Create `docker-compose.loki-staging.yml` file at project root for staging environment
  - Optional: Create `docker-compose.loki-production.yml` file at project root for production reference
  - Reason for skipping: Avoids code duplication; existing solution is flexible enough
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 19. Test Docker Loki plugin installation
  - Verify Docker Loki plugin installation command works on Linux
  - Verify docker plugin ls shows loki plugin
  - Verify plugin is enabled
  - Document any platform-specific issues
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 20. Test complete stack startup (OPTIONAL - NOT NEEDED)
  - Note: This task is redundant with task 19 (Docker Loki plugin already tested)
  - Note: docker-compose.loki.yml contains complete Quick Start Guide in inline comments (lines 80-120)
  - Note: All verification steps are documented in the file itself with exact commands
  - Note: Application code is identical to Promtail approach already tested in examples/
  - Note: The two approaches (Promtail vs Docker Loki driver) serve different purposes and can't be meaningfully tested together
  - Reason for skipping: Avoids duplicate testing; inline documentation is comprehensive and sufficient
  - If you want to verify manually: Follow the Quick Start Guide in docker-compose.loki.yml comments
  - Alternative: Run `docker compose -f docker-compose.loki.yml up -d` and verify 3 containers start
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 21. Test log ingestion flow
  - Make HTTP request to task-manager (curl http://localhost:8080/health)
  - Wait 5 seconds for log ingestion
  - Query Loki API for labels (curl http://localhost:3100/loki/api/v1/label)
  - Verify labels include service, environment, container_name
  - Query Loki API for logs (curl with LogQL query)
  - Verify logs appear with correct JSON structure
  - Verify request_id is present in logs
  - _Requirements: 1.2, 1.3, 18.1, 18.2, 18.3, 18.4, 18.5_

- [x] 22. Test Grafana data source configuration
  - Open Grafana at http://localhost:3000
  - Navigate to Configuration → Data Sources
  - Verify Loki data source exists and is default
  - Click "Test" button on Loki data source
  - Verify connection is successful
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 23. Test Grafana Explore interface
  - Open Grafana Explore view
  - Verify Loki is selected as data source
  - Run query: {service="task-manager-api"}
  - Verify logs appear in results
  - Test JSON field extraction: {service="task-manager-api"} | json
  - Verify JSON fields are parsed (level, msg, request_id, etc.)
  - Test filtering by level: {service="task-manager-api"} | json | level="INFO"
  - Verify only INFO logs appear
  - _Requirements: 4.1, 4.2, 4.3, 18.2, 18.3_

- [x] 24. Test request correlation
  - Make authenticated request to create a task
  - Extract request_id from logs in Grafana
  - Query logs by request_id: {service="task-manager-api"} | json | request_id="req_..."
  - Verify all logs for that request appear (request start, auth, DB operation, request complete)
  - Verify logs are in chronological order
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 25. Test time range and live tail
  - In Grafana Explore, change time range to "Last 5 minutes"
  - Verify only recent logs appear
  - Change time range to "Last 1 hour"
  - Verify more logs appear
  - Enable "Live" mode (live tail)
  - Make HTTP request to task-manager
  - Verify new logs appear automatically in Grafana
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 26. Test pre-built dashboards
  - Navigate to Dashboards in Grafana
  - Verify "Task Manager" folder exists
  - Open "Application Overview" dashboard
  - Verify all panels load with data
  - Open "Request Performance" dashboard
  - Verify all panels load with data
  - Open "Authentication & Security" dashboard
  - Verify all panels load with data
  - Open "Error Analysis" dashboard
  - Verify all panels load with data
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5, 11.1, 11.2, 11.3, 11.4, 11.5, 12.1, 12.2, 12.3, 12.4, 12.5_

- [ ] 27. Test error scenarios
  - Stop Loki container (docker compose -f docker-compose.loki.yml stop loki)
  - Make HTTP request to task-manager
  - Verify task-manager continues running (doesn't crash)
  - Restart Loki container (docker compose -f docker-compose.loki.yml start loki)
  - Wait 10 seconds
  - Make HTTP request to task-manager
  - Verify logs resume flowing to Loki
  - _Requirements: 1.2, 1.3_

- [ ] 28. Test multi-environment labels
  - Start second task-manager instance with environment="staging"
  - Query logs by environment: {environment="local"}
  - Verify only local logs appear
  - Query logs by environment: {environment="staging"}
  - Verify only staging logs appear
  - Query all logs: {service="task-manager-api"}
  - Verify both local and staging logs appear
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 29. Test log retention
  - Check Loki configuration has retention_period: 168h (7 days)
  - Verify retention_deletes_enabled: true in config
  - Document that logs older than 7 days will be automatically deleted
  - Provide command to check current storage usage (docker system df)
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 30. Test cleanup and reset
  - Run cleanup command (docker compose -f docker-compose.loki.yml down -v)
  - Verify all containers are stopped
  - Verify all volumes are removed
  - Restart stack (docker compose -f docker-compose.loki.yml up -d)
  - Verify fresh start with no old logs
  - _Requirements: 7.5, 17.5_

- [ ]* 31. Verify documentation completeness
  - Review GRAFANA_LOKI_QUICKSTART.md for accuracy
  - Review LOGQL_QUERY_REFERENCE.md for completeness
  - Review GRAFANA_DASHBOARDS.md for clarity
  - Review GRAFANA_LOKI_TROUBLESHOOTING.md for common issues
  - Review GRAFANA_LOKI_PRODUCTION.md for production guidance
  - Verify all links work
  - Verify all commands are correct
  - Verify all examples are tested
  - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.5, 14.1, 14.2, 14.3, 14.4, 14.5, 16.1, 16.2, 16.3, 16.4, 16.5_

- [ ]* 32. Create example queries cheat sheet
  - Create `docs/LOKI_QUERY_CHEATSHEET.md` file
  - Add quick reference for common queries
  - Add query for viewing all logs
  - Add query for filtering by log level
  - Add query for searching text in messages
  - Add query for filtering by request_id
  - Add query for filtering by user_id
  - Add query for counting errors per minute
  - Add query for finding slowest requests
  - Add query for viewing logs in time range
  - Format as easy-to-copy code blocks
  - _Requirements: 15.1, 15.2, 15.3, 15.4, 15.5, 15.6, 15.7, 15.8_
